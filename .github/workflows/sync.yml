name: MoySklad Daily Sync

on:
  schedule:
    # Запуск каждый день в 09:00 по Астане (03:00 UTC)
    - cron: '0 3 * * *'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Количество дней назад для загрузки'
        required: false
        default: '30'
      sync_mode:
        description: 'Режим синхронизации'
        required: false
        default: 'update'
        type: choice
        options:
          - update
          - replace
          - append

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create credentials file
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
    
    - name: Load configuration
      run: |
        python -c "
        import json
        import os
        
        config = {
            'moysklad_token': os.environ.get('MOYSKLAD_TOKEN'),
            'google_credentials_file': 'credentials.json',
            'spreadsheet_name': os.environ.get('SPREADSHEET_NAME', 'Финансовый отчёт'),
            'sync_schedule': 'daily',
            'sync_time': '09:00',
            'days_back': int(os.environ.get('DAYS_BACK', '30'))
        }
        
        with open('config.json', 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=4, ensure_ascii=False)
        
        print('✅ Configuration created')
        "
      env:
        MOYSKLAD_TOKEN: ${{ secrets.MOYSKLAD_TOKEN }}
        SPREADSHEET_NAME: ${{ secrets.SPREADSHEET_NAME }}
        DAYS_BACK: ${{ github.event.inputs.days_back || '30' }}
    
    - name: Run synchronization
      run: |
        python sync_script.py
      env:
        SYNC_MODE: ${{ github.event.inputs.sync_mode || 'update' }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: sync-logs
        path: |
          sync.log
          *.csv
        retention-days: 7
    
    - name: Commit sync state
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add sync_state.json config.json || true
        git commit -m "Update sync state [skip ci]" || true
        git push || true
    
    - name: Notify on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: '❌ MoySklad Sync Failed'
        body: |
          Синхронизация МойСклад завершилась с ошибкой.
          
          Время: ${{ github.event.head_commit.timestamp }}
          Workflow: ${{ github.workflow }}
          
          Проверьте логи: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: MoySklad Sync Bot